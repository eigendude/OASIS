/*
 *  Copyright (C) 2025 Garrett Brown
 *  This file is part of OASIS - https://github.com/eigendude/OASIS
 *
 *  SPDX-License-Identifier: Apache-2.0
 *  See the file LICENSE.txt for more information.
 */

#include "ViridisPaletteSampler.h"

#include <algorithm>
#include <array>
#include <cmath>
#include <cstdint>

using namespace OASIS;
using namespace SLAM;

namespace
{
const std::vector<cv::Vec3b> VIRIDIS_LUT = {
    // clang-format off
    cv::Vec3b(84, 1, 68),
    cv::Vec3b(86, 2, 68),
    cv::Vec3b(87, 4, 69),
    cv::Vec3b(89, 5, 69),
    cv::Vec3b(90, 7, 70),
    cv::Vec3b(92, 8, 70),
    cv::Vec3b(93, 10, 70),
    cv::Vec3b(94, 11, 70),
    cv::Vec3b(96, 13, 71),
    cv::Vec3b(97, 14, 71),
    cv::Vec3b(99, 16, 71),
    cv::Vec3b(100, 17, 71),
    cv::Vec3b(101, 19, 71),
    cv::Vec3b(103, 20, 72),
    cv::Vec3b(104, 22, 72),
    cv::Vec3b(105, 23, 72),
    cv::Vec3b(106, 24, 72),
    cv::Vec3b(108, 26, 72),
    cv::Vec3b(109, 27, 72),
    cv::Vec3b(110, 28, 72),
    cv::Vec3b(111, 29, 72),
    cv::Vec3b(112, 31, 72),
    cv::Vec3b(113, 32, 72),
    cv::Vec3b(115, 33, 72),
    cv::Vec3b(116, 35, 72),
    cv::Vec3b(117, 36, 72),
    cv::Vec3b(118, 37, 72),
    cv::Vec3b(119, 38, 72),
    cv::Vec3b(120, 40, 72),
    cv::Vec3b(121, 41, 72),
    cv::Vec3b(122, 42, 71),
    cv::Vec3b(122, 44, 71),
    cv::Vec3b(123, 45, 71),
    cv::Vec3b(124, 46, 71),
    cv::Vec3b(125, 47, 71),
    cv::Vec3b(126, 48, 70),
    cv::Vec3b(126, 50, 70),
    cv::Vec3b(127, 51, 70),
    cv::Vec3b(128, 52, 70),
    cv::Vec3b(129, 53, 69),
    cv::Vec3b(129, 55, 69),
    cv::Vec3b(130, 56, 69),
    cv::Vec3b(131, 57, 68),
    cv::Vec3b(131, 58, 68),
    cv::Vec3b(132, 59, 68),
    cv::Vec3b(132, 61, 67),
    cv::Vec3b(133, 62, 67),
    cv::Vec3b(133, 63, 66),
    cv::Vec3b(134, 64, 66),
    cv::Vec3b(134, 65, 66),
    cv::Vec3b(135, 66, 65),
    cv::Vec3b(135, 68, 65),
    cv::Vec3b(136, 69, 64),
    cv::Vec3b(136, 70, 64),
    cv::Vec3b(136, 71, 63),
    cv::Vec3b(137, 72, 63),
    cv::Vec3b(137, 73, 62),
    cv::Vec3b(137, 74, 62),
    cv::Vec3b(138, 76, 62),
    cv::Vec3b(138, 77, 61),
    cv::Vec3b(138, 78, 61),
    cv::Vec3b(138, 79, 60),
    cv::Vec3b(139, 80, 60),
    cv::Vec3b(139, 81, 59),
    cv::Vec3b(139, 82, 59),
    cv::Vec3b(139, 83, 58),
    cv::Vec3b(140, 84, 58),
    cv::Vec3b(140, 85, 57),
    cv::Vec3b(140, 86, 57),
    cv::Vec3b(140, 88, 56),
    cv::Vec3b(140, 89, 56),
    cv::Vec3b(140, 90, 55),
    cv::Vec3b(141, 91, 55),
    cv::Vec3b(141, 92, 54),
    cv::Vec3b(141, 93, 54),
    cv::Vec3b(141, 94, 53),
    cv::Vec3b(141, 95, 53),
    cv::Vec3b(141, 96, 52),
    cv::Vec3b(141, 97, 52),
    cv::Vec3b(141, 98, 51),
    cv::Vec3b(141, 99, 51),
    cv::Vec3b(142, 100, 50),
    cv::Vec3b(142, 101, 50),
    cv::Vec3b(142, 102, 49),
    cv::Vec3b(142, 103, 49),
    cv::Vec3b(142, 104, 49),
    cv::Vec3b(142, 105, 48),
    cv::Vec3b(142, 106, 48),
    cv::Vec3b(142, 107, 47),
    cv::Vec3b(142, 108, 47),
    cv::Vec3b(142, 109, 46),
    cv::Vec3b(142, 110, 46),
    cv::Vec3b(142, 111, 46),
    cv::Vec3b(142, 112, 45),
    cv::Vec3b(142, 113, 45),
    cv::Vec3b(142, 113, 44),
    cv::Vec3b(142, 114, 44),
    cv::Vec3b(142, 115, 44),
    cv::Vec3b(142, 116, 43),
    cv::Vec3b(142, 117, 43),
    cv::Vec3b(142, 118, 42),
    cv::Vec3b(142, 119, 42),
    cv::Vec3b(142, 120, 42),
    cv::Vec3b(142, 121, 41),
    cv::Vec3b(142, 122, 41),
    cv::Vec3b(142, 123, 41),
    cv::Vec3b(142, 124, 40),
    cv::Vec3b(142, 125, 40),
    cv::Vec3b(142, 126, 39),
    cv::Vec3b(142, 127, 39),
    cv::Vec3b(142, 128, 39),
    cv::Vec3b(142, 129, 38),
    cv::Vec3b(142, 130, 38),
    cv::Vec3b(142, 130, 38),
    cv::Vec3b(142, 131, 37),
    cv::Vec3b(142, 132, 37),
    cv::Vec3b(142, 133, 37),
    cv::Vec3b(142, 134, 36),
    cv::Vec3b(142, 135, 36),
    cv::Vec3b(142, 136, 35),
    cv::Vec3b(142, 137, 35),
    cv::Vec3b(141, 138, 35),
    cv::Vec3b(141, 139, 34),
    cv::Vec3b(141, 140, 34),
    cv::Vec3b(141, 141, 33),
    cv::Vec3b(141, 142, 33),
    cv::Vec3b(141, 143, 33),
    cv::Vec3b(141, 144, 32),
    cv::Vec3b(141, 145, 32),
    cv::Vec3b(141, 146, 32),
    cv::Vec3b(141, 146, 32),
    cv::Vec3b(140, 147, 32),
    cv::Vec3b(140, 148, 31),
    cv::Vec3b(140, 149, 31),
    cv::Vec3b(139, 149, 31),
    cv::Vec3b(139, 150, 31),
    cv::Vec3b(139, 151, 31),
    cv::Vec3b(139, 152, 31),
    cv::Vec3b(138, 153, 31),
    cv::Vec3b(138, 154, 31),
    cv::Vec3b(138, 155, 30),
    cv::Vec3b(137, 156, 30),
    cv::Vec3b(137, 157, 30),
    cv::Vec3b(137, 158, 31),
    cv::Vec3b(136, 159, 31),
    cv::Vec3b(136, 160, 31),
    cv::Vec3b(136, 161, 31),
    cv::Vec3b(135, 161, 31),
    cv::Vec3b(135, 162, 31),
    cv::Vec3b(134, 163, 32),
    cv::Vec3b(134, 164, 32),
    cv::Vec3b(133, 165, 33),
    cv::Vec3b(133, 166, 33),
    cv::Vec3b(133, 167, 34),
    cv::Vec3b(132, 168, 34),
    cv::Vec3b(131, 169, 35),
    cv::Vec3b(131, 170, 36),
    cv::Vec3b(130, 171, 37),
    cv::Vec3b(130, 172, 37),
    cv::Vec3b(129, 173, 38),
    cv::Vec3b(129, 173, 39),
    cv::Vec3b(128, 174, 40),
    cv::Vec3b(127, 175, 41),
    cv::Vec3b(127, 176, 42),
    cv::Vec3b(126, 177, 44),
    cv::Vec3b(125, 178, 45),
    cv::Vec3b(124, 179, 46),
    cv::Vec3b(124, 180, 47),
    cv::Vec3b(123, 181, 49),
    cv::Vec3b(122, 182, 50),
    cv::Vec3b(121, 182, 52),
    cv::Vec3b(121, 183, 53),
    cv::Vec3b(120, 184, 55),
    cv::Vec3b(119, 185, 56),
    cv::Vec3b(118, 186, 58),
    cv::Vec3b(117, 187, 59),
    cv::Vec3b(116, 188, 61),
    cv::Vec3b(115, 188, 63),
    cv::Vec3b(114, 189, 64),
    cv::Vec3b(113, 190, 66),
    cv::Vec3b(112, 191, 68),
    cv::Vec3b(111, 192, 70),
    cv::Vec3b(110, 193, 72),
    cv::Vec3b(109, 193, 74),
    cv::Vec3b(108, 194, 76),
    cv::Vec3b(107, 195, 78),
    cv::Vec3b(106, 196, 80),
    cv::Vec3b(105, 197, 82),
    cv::Vec3b(104, 197, 84),
    cv::Vec3b(103, 198, 86),
    cv::Vec3b(101, 199, 88),
    cv::Vec3b(100, 200, 90),
    cv::Vec3b(99, 200, 92),
    cv::Vec3b(98, 201, 94),
    cv::Vec3b(96, 202, 96),
    cv::Vec3b(95, 203, 99),
    cv::Vec3b(94, 203, 101),
    cv::Vec3b(92, 204, 103),
    cv::Vec3b(91, 205, 105),
    cv::Vec3b(90, 205, 108),
    cv::Vec3b(88, 206, 110),
    cv::Vec3b(87, 207, 112),
    cv::Vec3b(86, 208, 115),
    cv::Vec3b(84, 208, 117),
    cv::Vec3b(83, 209, 119),
    cv::Vec3b(81, 209, 122),
    cv::Vec3b(80, 210, 124),
    cv::Vec3b(78, 211, 127),
    cv::Vec3b(77, 211, 129),
    cv::Vec3b(75, 212, 132),
    cv::Vec3b(73, 213, 134),
    cv::Vec3b(72, 213, 137),
    cv::Vec3b(70, 214, 139),
    cv::Vec3b(69, 214, 142),
    cv::Vec3b(67, 215, 144),
    cv::Vec3b(65, 215, 147),
    cv::Vec3b(64, 216, 149),
    cv::Vec3b(62, 216, 152),
    cv::Vec3b(60, 217, 155),
    cv::Vec3b(59, 217, 157),
    cv::Vec3b(57, 218, 160),
    cv::Vec3b(55, 218, 162),
    cv::Vec3b(54, 219, 165),
    cv::Vec3b(52, 219, 168),
    cv::Vec3b(50, 220, 170),
    cv::Vec3b(48, 220, 173),
    cv::Vec3b(47, 221, 176),
    cv::Vec3b(45, 221, 178),
    cv::Vec3b(43, 222, 181),
    cv::Vec3b(41, 222, 184),
    cv::Vec3b(40, 222, 186),
    cv::Vec3b(38, 223, 189),
    cv::Vec3b(37, 223, 192),
    cv::Vec3b(35, 223, 194),
    cv::Vec3b(33, 224, 197),
    cv::Vec3b(32, 224, 200),
    cv::Vec3b(31, 225, 202),
    cv::Vec3b(29, 225, 205),
    cv::Vec3b(28, 225, 208),
    cv::Vec3b(27, 226, 210),
    cv::Vec3b(26, 226, 213),
    cv::Vec3b(25, 226, 216),
    cv::Vec3b(25, 227, 218),
    cv::Vec3b(24, 227, 221),
    cv::Vec3b(24, 227, 223),
    cv::Vec3b(24, 228, 226),
    cv::Vec3b(25, 228, 229),
    cv::Vec3b(25, 228, 231),
    cv::Vec3b(26, 229, 234),
    cv::Vec3b(27, 229, 236),
    cv::Vec3b(28, 229, 239),
    cv::Vec3b(29, 229, 241),
    cv::Vec3b(30, 230, 244),
    cv::Vec3b(32, 230, 246),
    cv::Vec3b(33, 230, 248),
    cv::Vec3b(35, 231, 251),
    cv::Vec3b(37, 231, 253)
    // clang-format on
};
} // namespace

const cv::Vec3b& ViridisPaletteSampler::Lookup(int index)
{
  return VIRIDIS_LUT[std::clamp(index, 0, static_cast<int>(VIRIDIS_LUT.size()) - 1)];
}

cv::Vec3b ViridisPaletteSampler::Sample(float value) const
{
  const float clamped = std::clamp(value, 0.0f, 1.0f);
  const float reversed = 1.0f - clamped;
  const float scaled = reversed * static_cast<float>(VIRIDIS_LUT.size() - 1);
  const int lowerIndex = static_cast<int>(std::floor(scaled));
  const int upperIndex = std::min(lowerIndex + 1, static_cast<int>(VIRIDIS_LUT.size() - 1));
  const float t = scaled - static_cast<float>(lowerIndex);

  if (upperIndex == lowerIndex)
    return Lookup(lowerIndex);

  const cv::Vec3b& lowerColor = Lookup(lowerIndex);
  const cv::Vec3b& upperColor = Lookup(upperIndex);
  cv::Vec3b result;
  for (int i = 0; i < 3; ++i)
  {
    const float channel =
        static_cast<float>(lowerColor[i]) + t * static_cast<float>(upperColor[i] - lowerColor[i]);
    result[i] = static_cast<uint8_t>(std::lround(channel));
  }

  return result;
}
